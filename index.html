<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShipsDNA - AIS Ship Tracking</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        /* Basic page styles */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: #1a1a1a;
        }

        /* Set the map container to fill the screen */
        #map {
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
        }

        /* Custom popup styles to match the dark theme */
        .leaflet-popup-content-wrapper {
            background: rgba(10, 10, 10, 0.9);
            color: #e0e0e0;
            border: 1px solid #008a23;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
        }
        .leaflet-popup-content {
            font-family: 'Roboto Mono', monospace;
            min-width: 240px;
        }
        .leaflet-popup-content h3 {
            color: #00ff41;
            margin: 0 0 8px 0;
            font-size: 16px;
        }
        .leaflet-popup-content p {
            margin: 4px 0;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }
        .leaflet-popup-content p strong {
            color: #aaa;
        }
        .leaflet-popup-tip {
            background: rgba(10, 10, 10, 0.9);
        }
        .leaflet-popup-close-button {
            color: #e0e0e0 !important;
        }
        .popup-button {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            border-radius: 4px;
            border: 1px solid #008a23;
            background-color: #008a23;
            color: #e0e0e0;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s;
        }
        .popup-button:hover {
            background-color: #00ff41;
            color: #1a1a1a;
        }


        /* Styles for the UI control panel */
        .leaflet-top.leaflet-right {
            top: 10px;
            right: 10px;
        }
        .control-panel {
            background: rgba(10, 10, 10, 0.85);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #008a23;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
            color: #e0e0e0;
            width: 250px;
        }
        .control-panel .search-modes {
            display: flex;
            margin-bottom: 10px;
        }
        .control-panel .search-modes button {
            flex: 1;
            padding: 8px;
            border: 1px solid #008a23;
            background-color: transparent;
            color: #008a23;
            cursor: pointer;
        }
        .control-panel .search-modes button:first-child {
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
        }
        .control-panel .search-modes button:last-child {
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
            border-left: none;
        }
        .control-panel .search-modes button.active {
            background-color: #008a23;
            color: #e0e0e0;
        }

        .control-panel input, .control-panel select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #008a23;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .control-panel select:disabled {
            background-color: #333;
            cursor: not-allowed;
        }
        .control-panel label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .control-panel button#reset-view {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
            border: 1px solid #008a23;
            background-color: #00ff41;
            color: #1a1a1a;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .control-panel button#reset-view:hover {
            background-color: #00cc34;
        }
        
        /* Loading Spinner */
        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 8px solid #f3f3f3;
            border-top: 8px solid #00ff41;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
            z-index: 1001;
            display: none;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Custom Alert Modal */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .alert-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .alert-modal {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #008a23;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.4);
            text-align: center;
            width: 90%;
            max-width: 400px;
            color: #e0e0e0;
        }
        .alert-modal h4 {
            color: #00ff41;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .alert-modal p {
            margin-bottom: 20px;
        }
        .alert-modal button {
            padding: 10px 20px;
            border: 1px solid #00ff41;
            background: #00ff41;
            color: #1a1a1a;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

    </style>
</head>
<body>

    <div id="map"></div>
    <div id="loader"></div>
    <div id="custom-alert" class="alert-overlay">
        <div class="alert-modal">
            <h4 id="alert-title"></h4>
            <p id="alert-message"></p>
            <button id="alert-ok">OK</button>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // --- Configuration ---
        const MAPTILER_API_KEY = 'onN3ELJ8eYBkrJfTNMbC';
        const PROXY_WORKER_URL = 'https://shipsdna-proxy.falling-flower-03ee.workers.dev/'; 

        // --- Global Variables ---
        let map;
        let currentVessels = [];
        let vesselMarkers = L.layerGroup();
        let historicalTrackLayer = L.layerGroup();
        let currentSearchMode = 'vessel'; // 'vessel' or 'port'

        // --- Mappings ---
        const vesselTypeMapping = {
            0: 'Not available', 1: 'Reserved', 2: 'Wing in ground', 3: 'Special Category',
            4: 'High speed craft', 5: 'Special Category', 6: 'Passenger', 7: 'Cargo', 8: 'Tanker',
            9: 'Other'
        };
        const vesselTypeColors = {
            4: '#ff4da6', 6: '#ff4da6', 7: '#4da6ff', 8: '#ffa64d', 9: '#cccccc',
            0: '#cccccc', 1: '#cccccc', 2: '#cccccc', 3: '#cccccc', 5: '#cccccc'
        };

        // --- UI & Map Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (MAPTILER_API_KEY === 'YOUR_MAPTILER_API_KEY_HERE' || PROXY_WORKER_URL === 'YOUR_CLOUDFLARE_WORKER_URL_HERE') {
                document.getElementById('map').innerHTML = `<div style="height: 100%; display: flex; align-items: center; justify-content: center; background-color: #333; color: white; text-align: center;"><h2>Please provide a MapTiler API key and the Cloudflare Worker URL in the script to start.</h2></div>`;
                return;
            }
            initializeMap();
            document.getElementById('alert-ok').addEventListener('click', () => {
                document.getElementById('custom-alert').classList.remove('visible');
            });
        });

        function initializeMap() {
            map = L.map('map').setView([20, 0], 2); 
            L.tileLayer(`https://api.maptiler.com/maps/dataviz-dark/{z}/{x}/{y}.png?key=${MAPTILER_API_KEY}`, { attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>' }).addTo(map);
            vesselMarkers.addTo(map);
            historicalTrackLayer.addTo(map);
            addControls();
        }
        
        function addControls() {
            const ControlPanel = L.Control.extend({
                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'control-panel');
                    container.innerHTML = `
                        <h3>Ship Tracking</h3>
                        <div class="search-modes">
                            <button id="mode-vessel" class="active">Vessel Search</button>
                            <button id="mode-port">Port Search</button>
                        </div>
                        <label for="search" id="search-label">Search (IMO/MMSI/Name)</label>
                        <input type="text" id="search" placeholder="Search vessel to begin...">
                        <label for="vesselType">Filter by Type</label>
                        <select id="vesselType" disabled>
                            <option value="all">All Types</option>
                            <option value="6">Passenger/Cruise</option>
                            <option value="7">Cargo/Container</option>
                            <option value="8">Tanker</option>
                            <option value="9">Other</option>
                        </select>
                        <div id="reset-button-container"></div>
                    `;
                    L.DomEvent.disableClickPropagation(container);
                    return container;
                }
            });
            new ControlPanel({ position: 'topright' }).addTo(map);
            
            document.getElementById('mode-vessel').addEventListener('click', () => setSearchMode('vessel'));
            document.getElementById('mode-port').addEventListener('click', () => setSearchMode('port'));
            document.getElementById('vesselType').addEventListener('change', (e) => filterVessels(e.target.value));
            document.getElementById('search').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    if (currentSearchMode === 'vessel') searchVessels(e.target.value);
                    else searchPort(e.target.value);
                }
            });
        }
        
        function setSearchMode(mode) {
            currentSearchMode = mode;
            const vesselButton = document.getElementById('mode-vessel');
            const portButton = document.getElementById('mode-port');
            const searchInput = document.getElementById('search');
            const searchLabel = document.getElementById('search-label');

            if (mode === 'vessel') {
                vesselButton.classList.add('active');
                portButton.classList.remove('active');
                searchInput.placeholder = 'Search vessel to begin...';
                searchLabel.textContent = 'Search (IMO/MMSI/Name)';
            } else {
                portButton.classList.add('active');
                vesselButton.classList.remove('active');
                searchInput.placeholder = 'e.g., Singapore';
                searchLabel.textContent = 'Search Port Name';
            }
        }

        // --- API & Data Handling ---
        async function apiRequest(targetApiUrl, context) {
            const proxyUrl = `${PROXY_WORKER_URL}?url=${encodeURIComponent(targetApiUrl)}`;
            try {
                const response = await fetch(proxyUrl);
                const result = await response.json(); 
                if (!response.ok) throw new Error(result.message || `Proxy Error: ${response.statusText}`);
                if (result.status === 'success') return result.data;
                else throw new Error(result.message || 'An unknown API error occurred.');
            } catch (error) {
                handleFetchError(error, context);
                return null;
            }
        }

        async function searchVessels(query) {
            if (query.length < 3) return showCustomAlert('Search Error', 'Please enter at least 3 characters to search.');
            document.getElementById('loader').style.display = 'block';

            const targetApiUrl = `https://api.myshiptracking.com/api/v2/vessel/search?name=${encodeURIComponent(query)}`;
            const searchResults = await apiRequest(targetApiUrl, "vessel search");

            if (searchResults && searchResults.length > 0) {
                await fetchVesselDetails(searchResults.map(v => v.mmsi), true);
            } else if (searchResults) { 
                showCustomAlert('Not Found', `No vessels found for "${query}".`);
                vesselMarkers.clearLayers();
            }
            document.getElementById('loader').style.display = 'none';
        }

        async function searchPort(query) {
            if (query.length < 3) return showCustomAlert('Search Error', 'Please enter at least 3 characters to search for a port.');
            document.getElementById('loader').style.display = 'block';

            const portSearchUrl = `https://api.myshiptracking.com/api/v2/port/search?name=${encodeURIComponent(query)}`;
            const portResults = await apiRequest(portSearchUrl, `port search for "${query}"`);

            if (!portResults || portResults.length === 0) {
                showCustomAlert('Not Found', `Port "${query}" not found.`);
                document.getElementById('loader').style.display = 'none';
                return;
            }
            const portId = portResults[0].port_id;

            const vesselsInPortUrl = `https://api.myshiptracking.com/api/v2/port/inport?port_id=${portId}`;
            const vesselsInPort = await apiRequest(vesselsInPortUrl, `vessels in port ${portResults[0].name}`);

            if (!vesselsInPort || vesselsInPort.length === 0) {
                showCustomAlert('No Vessels', `No vessels are currently in the port of ${portResults[0].name}.`);
                document.getElementById('loader').style.display = 'none';
                return;
            }
            
            await fetchVesselDetails(vesselsInPort.map(v => v.mmsi), true);
            document.getElementById('loader').style.display = 'none';
        }

        async function fetchVesselDetails(mmsiList, isNewSearch) {
            const BATCH_SIZE = 100;
            const batches = [];
            for (let i = 0; i < mmsiList.length; i += BATCH_SIZE) {
                batches.push(mmsiList.slice(i, i + BATCH_SIZE));
            }

            try {
                const batchPromises = batches.map(batch => {
                    const targetApiUrl = `https://api.myshiptracking.com/api/v2/vessel/bulk?mmsi=${batch.join(',')}`;
                    return apiRequest(targetApiUrl, "vessel details batch");
                });
                
                const results = await Promise.all(batchPromises);
                const vesselDetails = results.flat().filter(Boolean); 

                if (vesselDetails.length > 0) {
                    currentVessels = vesselDetails;
                    plotVessels(currentVessels);
                    if (isNewSearch) {
                        historicalTrackLayer.clearLayers();
                        const validCoords = currentVessels.map(v => [v.lat, v.lng]).filter(coords => coords[0] != null && coords[1] != null);
                        if (validCoords.length > 0) {
                            const bounds = L.latLngBounds(validCoords);
                            map.flyToBounds(bounds, { padding: [50, 50] });
                        }
                        document.getElementById('vesselType').disabled = false;
                        addResetButton();
                    }
                }
            } catch (error) {
                 console.error("An error occurred during batch processing of vessel details.");
            }
        }

        // --- Vessel Plotting & UI ---
        function plotVessels(vessels) {
            vesselMarkers.clearLayers();
            if (!vessels || vessels.length === 0) return;

            vessels.forEach(vessel => {
                if (vessel.lat == null || vessel.lng == null) return;
                const color = vesselTypeColors[vessel.vtype] || vesselTypeColors[9];
                const iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="${color}" style="transform: rotate(${vessel.course || 0}deg);"><path d="M12 2L2.5 21.5h19L12 2z"/></svg>`;
                const customIcon = L.divIcon({ html: iconHtml, className: '', iconSize: [24, 24], iconAnchor: [12, 12] });
                const marker = L.marker([vessel.lat, vessel.lng], { icon: customIcon }).addTo(vesselMarkers);
                marker.on('click', () => fetchExtendedDetails(vessel.mmsi, marker));
            });
        }
        
        async function fetchExtendedDetails(mmsi, marker) {
            marker.bindPopup("<h3>Loading details...</h3>").openPopup();
            const targetApiUrl = `https://api.myshiptracking.com/api/v2/vessel?mmsi=${mmsi}&response=extended`;
            const data = await apiRequest(targetApiUrl, `extended details for MMSI ${mmsi}`);
            if (data) {
                marker.bindPopup(createExtendedPopupContent(data)).openPopup();
            } else {
                marker.bindPopup("<h3>Could not load details.</h3><p>Please try again later.</p>").openPopup();
            }
        }

        function createExtendedPopupContent(vessel) {
            const na = '<span>N/A</span>';
            const size = (vessel.size_a && vessel.size_b && vessel.size_c && vessel.size_d) ? `<span>${vessel.size_a + vessel.size_b}m x ${vessel.size_c + vessel.size_d}m</span>` : na;
            const tonnage = (vessel.gt && vessel.dwt) ? `<span>${vessel.gt} / ${vessel.dwt}</span>` : na;
            const destination = vessel.destination ? `<span>${vessel.destination}</span>` : na;
            const eta = vessel.eta ? `<span>${new Date(vessel.eta).toLocaleString()}</span>` : na;
            // Updated button text
            return `<h3>${vessel.vessel_name || 'N/A'}</h3><p><strong>Flag:</strong> <span>${vessel.flag || 'N/A'}</span></p><p><strong>Callsign:</strong> <span>${vessel.callsign || 'N/A'}</span></p><p><strong>IMO/MMSI:</strong> <span>${vessel.imo || 'N/A'} / ${vessel.mmsi}</span></p><p><strong>Type:</strong> <span>${vessel.vessel_type || 'Unknown'}</span></p><p><strong>Size (L×B):</strong> ${size}</p><p><strong>Tonnage (GT/DWT):</strong> ${tonnage}</p><p><strong>Built:</strong> <span>${vessel.built || 'N/A'}</span></p><p><strong>Destination:</strong> ${destination}</p><p><strong>ETA:</strong> ${eta}</p><button class="popup-button" onclick="fetchVesselTrack(${vessel.mmsi})">Show 7-Day Track</button>`;
        }
        
        async function fetchVesselTrack(mmsi) {
            document.getElementById('loader').style.display = 'block';
            map.closePopup();
            
            const todate = new Date().toISOString().split('.')[0] + 'Z';
            // Updated to 7 days
            const fromdate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('.')[0] + 'Z';

            const targetApiUrl = `https://api.myshiptracking.com/api/v2/vessel/track?mmsi=${mmsi}&fromdate=${fromdate}&todate=${todate}`;
            const trackData = await apiRequest(targetApiUrl, `historical track for MMSI ${mmsi}`);
            
            if (trackData && trackData.length > 0) {
                historicalTrackLayer.clearLayers();
                const latlngs = trackData.map(pos => [pos.lat, pos.lng]).filter(coord => coord[0] != null && coord[1] != null);
                if (latlngs.length > 1) {
                    const polyline = L.polyline(latlngs, { color: '#00ff41', weight: 3 });
                    historicalTrackLayer.addLayer(polyline);
                    const trackBounds = L.latLngBounds(latlngs);
                    map.flyToBounds(trackBounds, { padding: [50, 50] });
                } else {
                     showCustomAlert('Track Error', 'Not enough valid track data to draw a path for this vessel.');
                }
            } else {
                // Updated alert message
                showCustomAlert('Track Error', 'No historical track data available for this vessel in the last 7 days.');
            }
            document.getElementById('loader').style.display = 'none';
        }

        function filterVessels(vesselType) {
            let filteredVessels = (vesselType === 'all') ? currentVessels : currentVessels.filter(vessel => vessel.vtype == parseInt(vesselType));
            plotVessels(filteredVessels);
        }
        
        function resetMapView() {
            document.getElementById('search').value = '';
            document.getElementById('vesselType').value = 'all';
            document.getElementById('vesselType').disabled = true;
            document.getElementById('reset-button-container').innerHTML = '';
            vesselMarkers.clearLayers();
            historicalTrackLayer.clearLayers();
            currentVessels = [];
            map.flyTo([20, 0], 2);
            setSearchMode('vessel');
        }
        
        function addResetButton() {
            const container = document.getElementById('reset-button-container');
            container.innerHTML = '<button id="reset-view">Reset View</button>';
            document.getElementById('reset-view').addEventListener('click', resetMapView);
        }
        
        function handleFetchError(error, context) {
            console.error(`Failed to fetch ${context}:`, error);
            showCustomAlert('API Error', `An error occurred while fetching ${context}: ${error.message}`);
        }
        
        function showCustomAlert(title, message) {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            document.getElementById('custom-alert').classList.add('visible');
        }

    </script>
</body>
</html>

