<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShipsDNA - AIS Ship Tracking</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        /* ... existing styles ... */

        .control-panel button {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
            border: 1px solid #008a23;
            background-color: #00ff41;
            color: #1a1a1a;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .control-panel button:hover {
            background-color: #00cc34;
        }

        /* ... existing styles ... */
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="loader"></div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // --- Configuration ---
        const MAPTILER_API_KEY = 'onN3ELJ8eYBkrJfTNMbC';
        const PROXY_WORKER_URL = 'https://shipsdna-proxy.falling-flower-03ee.workers.dev/'; 

        // --- Global Variables ---
        let map;
        let allVessels = []; // To store the initial zone dataset
        let vesselMarkers = L.layerGroup(); // Layer to hold all vessel markers
        let isSearchView = false; // Flag to track if we're in a search view

        // --- Mappings ---
        const vesselTypeMapping = {
            // Updated to include more types from the API docs
            0: 'Not available', 1: 'Reserved', 2: 'Wing in ground', 3: 'Special Category',
            4: 'High speed craft', 5: 'Special Category', 6: 'Passenger', 7: 'Cargo', 8: 'Tanker',
            9: 'Other'
        };
        const vesselTypeColors = {
            4: '#ff4da6', 6: '#ff4da6', 7: '#4da6ff', 8: '#ffa64d', 9: '#cccccc',
            // Default colors for other types
            0: '#cccccc', 1: '#cccccc', 2: '#cccccc', 3: '#cccccc', 5: '#cccccc'
        };

        // --- UI & Map Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (MAPTILER_API_KEY === 'YOUR_MAPTILER_API_KEY_HERE' || PROXY_WORKER_URL === 'YOUR_CLOUDFLARE_WORKER_URL_HERE') {
                document.getElementById('map').innerHTML = `
                    <div style="height: 100%; display: flex; align-items: center; justify-content: center; background-color: #333; color: white; text-align: center;">
                        <h2>Please provide a MapTiler API key and the Cloudflare Worker URL in the script to start.</h2>
                    </div>`;
                return;
            }
            initializeMap();
        });

        function initializeMap() {
            map = L.map('map').setView([50.5, 1.0], 7); // Centered on the English Channel

            L.tileLayer(
                `https://api.maptiler.com/maps/dataviz-dark/{z}/{x}/{y}.png?key=${MAPTILER_API_KEY}`, {
                    attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
                }
            ).addTo(map);

            vesselMarkers.addTo(map);
            addControls();
            fetchVesselsInZone();
        }
        
        function addControls() {
            const ControlPanel = L.Control.extend({
                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'control-panel');
                    container.innerHTML = `
                        <h3>Ship Tracking</h3>
                        <label for="search">Search (IMO/MMSI/Name)</label>
                        <input type="text" id="search" placeholder="e.g., EVER GIVEN">
                        
                        <label for="vesselType">Filter by Type</label>
                        <select id="vesselType">
                            <option value="all">All Types</option>
                            <option value="6">Passenger/Cruise</option>
                            <option value="7">Cargo/Container</option>
                            <option value="8">Tanker</option>
                            <option value="9">Other</option>
                        </select>
                        <div id="reset-button-container"></div>
                    `;
                    L.DomEvent.disableClickPropagation(container);
                    return container;
                }
            });
            new ControlPanel({ position: 'topright' }).addTo(map);
            
            // Add event listeners
            document.getElementById('vesselType').addEventListener('change', (e) => filterVessels(e.target.value));
            document.getElementById('search').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    searchVessels(e.target.value);
                }
            });
        }

        // --- API & Data Handling ---
        async function fetchVesselsInZone() {
            isSearchView = false;
            const loader = document.getElementById('loader');
            loader.style.display = 'block';
            document.getElementById('reset-button-container').innerHTML = ''; // Hide reset button

            const minlon = -5.0, maxlon = 5.0, minlat = 48.5, maxlat = 52.5;
            const targetApiUrl = `https://api.myshiptracking.com/api/v2/vessel/zone?minlon=${minlon}&maxlon=${maxlon}&minlat=${minlat}&maxlat=${maxlat}`;
            const proxyUrl = `${PROXY_WORKER_URL}?url=${encodeURIComponent(targetApiUrl)}`;

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`Proxy Error: ${response.statusText}`);
                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    allVessels = result.data;
                    plotVessels(allVessels);
                    map.setView([50.5, 1.0], 7);
                } else {
                    handleApiError(result);
                }
            } catch (error) {
                handleFetchError(error, "vessels in zone");
            } finally {
                loader.style.display = 'none';
            }
        }

        async function searchVessels(query) {
            if (query.length < 3) {
                alert('Please enter at least 3 characters to search.');
                return;
            }
            isSearchView = true;
            const loader = document.getElementById('loader');
            loader.style.display = 'block';

            // Vessel Search endpoint
            const targetApiUrl = `https://api.myshiptracking.com/api/v2/vessel/search?name=${encodeURIComponent(query)}`;
            const proxyUrl = `${PROXY_WORKER_URL}?url=${encodeURIComponent(targetApiUrl)}`;

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`Proxy Error: ${response.statusText}`);
                const result = await response.json();

                if (result.status === 'success' && result.data && result.data.length > 0) {
                    // We only get basic info from search, so we need to fetch detailed status for each vessel
                    await fetchVesselDetails(result.data);
                } else if (result.status === 'success') {
                    alert(`No vessels found for "${query}".`);
                    vesselMarkers.clearLayers();
                } else {
                    handleApiError(result);
                }
            } catch (error) {
                handleFetchError(error, "vessel search");
            } finally {
                loader.style.display = 'none';
            }
        }

        async function fetchVesselDetails(searchResults) {
            const mmsiList = searchResults.map(v => v.mmsi).join(',');
            const targetApiUrl = `https://api.myshiptracking.com/api/v2/vessel/bulk?mmsi=${mmsiList}`;
            const proxyUrl = `${PROXY_WORKER_URL}?url=${encodeURIComponent(targetApiUrl)}`;

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`Proxy Error: ${response.statusText}`);
                const result = await response.json();
                
                if (result.status === 'success' && result.data) {
                    plotVessels(result.data);
                    
                    // Auto-zoom to the search results
                    const bounds = L.latLngBounds(result.data.map(v => [v.lat, v.lng]));
                    if(bounds.isValid()) {
                       map.flyToBounds(bounds, { padding: [50, 50] });
                    }
                    
                    addResetButton();
                } else {
                     handleApiError(result);
                }
            } catch(error) {
                 handleFetchError(error, "vessel details");
            }
        }

        // --- Vessel Plotting & UI ---
        function plotVessels(vessels) {
            vesselMarkers.clearLayers();
            if (!vessels || vessels.length === 0) return;

            vessels.forEach(vessel => {
                if (!vessel.lat || !vessel.lng) return; // Don't plot ships without coordinates
                const color = vesselTypeColors[vessel.vtype] || vesselTypeColors[9];
                const iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="${color}" style="transform: rotate(${vessel.course || 0}deg);"><path d="M12 2L2.5 21.5h19L12 2z"/></svg>`;
                const customIcon = L.divIcon({ html: iconHtml, className: '', iconSize: [24, 24], iconAnchor: [12, 12] });
                
                const popupContent = `
                    <h3>${vessel.vessel_name || 'N/A'}</h3>
                    <p><strong>MMSI:</strong> ${vessel.mmsi}</p>
                    <p><strong>Type:</strong> ${vesselTypeMapping[vessel.vtype] || 'Unknown'}</p>
                    <p><strong>Speed:</strong> ${vessel.speed != null ? vessel.speed + ' knots' : 'N/A'}</p>
                `;

                L.marker([vessel.lat, vessel.lng], { icon: customIcon })
                    .addTo(vesselMarkers)
                    .bindPopup(popupContent);
            });
        }
        
        function filterVessels(vesselType) {
            if (isSearchView) {
                alert("Cannot filter in search view. Please reset to see all vessels in the zone.");
                document.getElementById('vesselType').value = 'all'; // Reset dropdown
                return;
            }
            let filteredVessels = (vesselType === 'all')
                ? allVessels
                : allVessels.filter(vessel => vessel.vtype == parseInt(vesselType));
            plotVessels(filteredVessels);
        }
        
        function addResetButton() {
            const container = document.getElementById('reset-button-container');
            container.innerHTML = '<button id="reset-view">Reset View</button>';
            document.getElementById('reset-view').addEventListener('click', () => {
                document.getElementById('search').value = '';
                fetchVesselsInZone();
            });
        }
        
        function handleApiError(result) {
            console.error("API Error:", result.message);
            alert(`API Error: ${result.message || 'An unknown error occurred.'}`);
        }

        function handleFetchError(error, context) {
            console.error(`Failed to fetch ${context}:`, error);
            alert(`An error occurred while fetching ${context}. Check the console for details.`);
        }

    </script>
</body>
</html>

